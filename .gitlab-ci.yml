stages:
  - test
  - build
  
variables:
  # Docker 相关配置
  DOCKER_REGISTRY: registry.cocofhu.cc
  DOCKER_HOST: tcp://docker:2375
  TENCENT_REGISTRY: ccr.ccs.tencentyun.com
  DOCKER_TLS_CERTDIR: ""
  DOCKER_DRIVER: overlay2
  
  # 项目配置
  PROJECT_NAME: mcp-adapter
  DOCKER_IMAGE_PATH: cocofhu/mcp-adapter

# 测试阶段
test:unit:
  image: golang:1.25
  stage: test
  before_script:
    - go mod download
    - go install github.com/boumenot/gocover-cobertura@latest
  script:
    # 运行单元测试并生成覆盖率报告
    - go test -v -race -coverprofile=coverage.out -covermode=atomic ./...
    # 显示覆盖率统计
    - go tool cover -func=coverage.out
    # 生成 HTML 覆盖率报告
    - go tool cover -html=coverage.out -o coverage.html
    # 生成 Cobertura 格式的覆盖率报告
    - gocover-cobertura < coverage.out > coverage.xml
  coverage: '/total:\s+\(statements\)\s+(\d+\.\d+)%/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml
    paths:
      - coverage.out
      - coverage.html
      - coverage.xml
    expire_in: 30 days
  rules:
    - if: $CI_COMMIT_BRANCH
    - if: $CI_COMMIT_TAG

# 代码质量检查
test:lint:
  image: golang:1.25
  stage: test
  before_script:
    # 安装 golangci-lint
    - curl -sSfL https://raw.githubusercontent.com/golangci/golangci-lint/master/install.sh | sh -s -- -b $(go env GOPATH)/bin v1.61.0
    - export PATH=$PATH:$(go env GOPATH)/bin
  script:
    # 运行 golangci-lint 进行代码质量检查
    - golangci-lint run --timeout 5m --out-format colored-line-number ./...
  allow_failure: true
  rules:
    - if: $CI_COMMIT_BRANCH
    - if: $CI_COMMIT_TAG

# 安全扫描
test:security:
  image: securego/gosec:latest
  stage: test
  script:
    # 运行 gosec 进行安全漏洞扫描
    # 排除 vendor 和测试文件，只扫描源代码
    - gosec -fmt json -out gosec-report.json -exclude-dir=vendor -exclude-dir=.git ./... || true
    - gosec -exclude-dir=vendor -exclude-dir=.git ./...
  artifacts:
    paths:
      - gosec-report.json
    expire_in: 30 days
  allow_failure: true
  rules:
    - if: $CI_COMMIT_BRANCH
    - if: $CI_COMMIT_TAG

# 依赖检查
test:dependencies:
  image: golang:1.25
  stage: test
  before_script:
    - go install golang.org/x/vuln/cmd/govulncheck@latest
  script:
    # 检查依赖的已知漏洞
    - govulncheck ./...
  allow_failure: true
  rules:
    - if: $CI_COMMIT_BRANCH
    - if: $CI_COMMIT_TAG


# Docker 构建和推送
docker-build:
  image: docker:cli
  stage: build
  services:
    - name: docker:dind
      entrypoint: ["env", "-u", "DOCKER_HOST"]
      command: ["dockerd-entrypoint.sh", "--insecure-registry=registry.cocofhu.cc"]
  before_script:
    # 设置版本号
    - |
      if [ -n "$CI_COMMIT_TAG" ]; then
        export VERSION="$CI_COMMIT_TAG"
      else
        export VERSION="v1.4.1-${CI_COMMIT_SHORT_SHA}"
      fi
    # 设置镜像名称
    - export DOCKER_IMAGE_NAME="$DOCKER_REGISTRY/$PROJECT_NAME:$VERSION"
    - export DOCKER_IMAGE_LATEST="$DOCKER_REGISTRY/$PROJECT_NAME:latest"
    - export DOCKER_IMAGE_TENCENT="$TENCENT_REGISTRY/$DOCKER_IMAGE_PATH:$VERSION"
    - export DOCKER_IMAGE_TENCENT_LATEST="$TENCENT_REGISTRY/$DOCKER_IMAGE_PATH:latest"
    - echo "Building Docker image $DOCKER_IMAGE_NAME"
  script:
    # 构建 Docker 镜像
    - docker build --pull -t "$DOCKER_IMAGE_NAME" .
    
    # 推送到内部仓库
    - docker push "$DOCKER_IMAGE_NAME"
    
    # 如果是主分支或标签，推送 latest 和腾讯云镜像
    - |
      if [[ "$CI_COMMIT_REF_NAME" == "$CI_DEFAULT_BRANCH" ]] || [[ -n "$CI_COMMIT_TAG" ]]; then
        echo "Pushing latest tag and Tencent registry images..."
        
        # 推送 latest 到内部仓库
        docker tag "$DOCKER_IMAGE_NAME" "$DOCKER_IMAGE_LATEST"
        docker push "$DOCKER_IMAGE_LATEST"
        
        # 登录腾讯云镜像仓库
        docker login ccr.ccs.tencentyun.com --username="$TENCENT_DOCKER_USER" --password="$TENCENT_DOCKER_PASS"
        
        # 推送到腾讯云仓库
        docker tag "$DOCKER_IMAGE_NAME" "$DOCKER_IMAGE_TENCENT"
        docker push "$DOCKER_IMAGE_TENCENT"
        
        docker tag "$DOCKER_IMAGE_NAME" "$DOCKER_IMAGE_TENCENT_LATEST"
        docker push "$DOCKER_IMAGE_TENCENT_LATEST"
        
        echo "All images pushed successfully!"
      fi
  after_script:
    - docker images
  rules:
    - if: $CI_COMMIT_BRANCH
      exists:
        - Dockerfile
    - if: $CI_COMMIT_TAG
      exists:
        - Dockerfile

