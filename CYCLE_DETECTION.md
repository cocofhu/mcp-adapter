# 循环引用检测功能

## 概述

为了防止自定义类型和接口参数出现循环引用,后端使用 **拓扑排序 (Kahn 算法)** 进行判环检测。

## 功能说明

### 1. 自定义类型循环引用检测

当创建或更新自定义类型时,系统会检测字段引用关系是否形成环。

#### 检测场景

- **创建自定义类型**: 检查新类型的字段引用是否会导致循环
- **更新自定义类型**: 检查更新后的字段引用是否会导致循环

#### 示例

```
类型A { field: 类型B }
类型B { field: 类型A }
```

这种情况会被检测为循环引用并拒绝创建/更新。

#### 自引用检测

```
类型A { field: 类型A }
```

自引用也会被检测为循环引用。

### 2. 接口参数循环引用检测

当创建或更新接口时,系统会检测参数引用的自定义类型是否存在循环引用。

#### 检测逻辑

接口参数可能引用自定义类型,而自定义类型的字段也可能引用其他自定义类型。系统会:

1. 构建所有自定义类型的引用关系图
2. 对每个接口参数引用的类型,使用 DFS 检测是否存在环

## 实现细节

### 拓扑排序 (Kahn 算法)

使用基于入度的拓扑排序算法检测有向图中的环:

1. **构建引用图**: `typeID -> []refTypeID` (邻接表)
2. **计算入度**: 统计每个节点的入度
3. **BFS 处理**: 
   - 将所有入度为 0 的节点加入队列
   - 依次处理队列中的节点,将其邻接节点的入度减 1
   - 如果邻接节点入度变为 0,加入队列
4. **判断结果**: 如果处理的节点数小于总节点数,说明存在环

**算法优势:**
- ✅ 时间复杂度: O(V + E) - 只需遍历一次图
- ✅ 空间复杂度: O(V) - 只需存储入度表和队列
- ✅ 无递归: 避免栈溢出风险
- ✅ 性能稳定: 不受图结构影响

### 代码位置

- **自定义类型检测**: `backend/service/custom_type_service.go`
  - `checkCustomTypeCycle()`: 创建时检测
  - `checkCustomTypeCycleForUpdate()`: 更新时检测

- **接口参数检测**: `backend/service/interface_service.go`
  - `checkInterfaceParameterCycle()`: 创建时检测
  - `checkInterfaceParameterCycleForUpdate()`: 更新时检测

## 错误信息

当检测到循环引用时,会返回以下错误:

- 自定义类型: `"circular reference detected in custom type fields"`
- 接口参数: `"circular reference detected in interface parameters"`

## 测试

运行测试脚本验证功能:

```powershell
# Windows PowerShell
.\test_cycle_detection.ps1
```

```bash
# Linux/Mac
./test_cycle_detection.sh
```

测试脚本会验证:

1. ✅ 正常的类型引用 (A -> B)
2. ❌ 循环引用 (A -> B -> A)
3. ❌ 自引用 (A -> A)
4. ✅ 接口参数使用正常类型
5. ❌ 接口参数使用有循环引用的类型

## 性能考虑

- **时间复杂度**: O(V + E),其中 V 是类型数量,E 是引用关系数量
- **空间复杂度**: O(V),用于存储访问状态和递归栈

对于大多数应用场景,类型数量不会太多,性能影响可以忽略。

## 注意事项

1. 循环引用检测在**事务提交前**进行,如果检测失败会回滚事务
2. 检测范围限定在**同一应用**内的类型
3. 数组类型 (`is_array: true`) 也会被检测循环引用
4. 更新类型时,会用新的字段列表替换旧的,然后进行检测
